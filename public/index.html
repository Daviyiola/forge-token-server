<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digital Twin Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <!-- Viewer -->
  <div id="viewer" data-urn="urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6ZXRzdV93d2hfZGlnaXRhbF90d2luX2NsYXNzcm9vbXMvZGlnaXRhbF9sYWJfbW9kZWxfd3doXzMucnZ0"></div>

  <!-- Floating selection menu (viewer-driven) -->
  <div id="selMenu" aria-live="polite">
    <div class="title" id="selTitle">Selected</div>

    <div id="telemetry" class="rows" style="display:none">
      <div class="k">Relay</div>     <div class="v" id="tRelay">—</div>
      <div class="k">Power (W)</div> <div class="v" id="tPower">—</div>
      <div class="k">Updated</div>   <div class="v" id="tUpdated">—</div>
      <div class="k">Note</div>      <div class="v" id="tNote">—</div>
    </div>

    <button class="btn" data-action="zoom">Zoom to</button>
    <button class="btn" data-action="isolate">Isolate</button>
    <button class="btn" data-action="clear">Clear isolation</button>
    <hr />
    <div id="deviceActions"></div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- MENU button (replaces Dashboard) -->
  <button id="menuBtn" type="button" title="Open menu">Menu</button>

  <!-- Drawer -->
  <aside id="drawer" aria-hidden="true">
    <div id="drawerHdr">
      <div class="ttl">Menu</div>
      <button class="x" id="drawerClose" type="button" aria-label="Close">Close</button>
    </div>
    <nav id="drawerNav" aria-label="Sections">
      <button class="nav-item" data-open="day">Day Playback</button>
      <button class="nav-item" data-open="rules">Rules</button>
      <button class="nav-item" data-open="alerts">Alerts</button>
      <button class="nav-item" data-open="summaries">Summaries</button>
      <button class="nav-item" data-open="heatmap">Heatmap</button>
    </nav>
  </aside>

  <!-- Popups (re-usable modal shells) -->
  <div class="modal-mask" id="popupMask" style="display:none;">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
      <div class="popupHdr">
        <div id="popupTitle">Popup</div>
        <button class="x" id="popupClose" type="button" aria-label="Close popup">×</button>
      </div>
      <div class="popupBody" id="popupBody">
        <!-- You can inject any content dynamically here -->
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal-mask" id="authMask" style="display:none;">
    <div id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle">Enter password to control devices</h3>
      <p>Controls are locked. Enter the access password to toggle devices. This stays unlocked for up to <strong>12 hours</strong> or until you lock or reload.</p>
      <div class="field">
        <input id="pwInput" type="password" placeholder="Password" autocomplete="off" />
      </div>
      <div class="err" id="pwErr"></div>
      <div class="rowBtns">
        <button class="btnS" id="pwCancel" type="button">Cancel</button>
        <button class="btnP" id="pwSubmit" type="button" disabled>Unlock</button>
      </div>
    </div>
  </div>

  <!-- Lock chip -->
  <button id="lockChip" class="chip chip-locked" title="Click to unlock controls">
    <span class="dot"></span><span class="label">Locked</span>
  </button>

  <!-- Metrics dock (default hidden/compact) -->
<div id="metricsDock" class="compact" aria-live="polite">
  <div class="hdr">
  <div class="titleWrap">
    
    <!-- Room switcher button -->
    <button
      id="mxRoomSwitch"
      type="button"
      title="Change room"
      aria-label="Change room"
    >
      ≡
    </button>
    <div class="title">Lab Sensors</div>
    <!-- Room list menu (populated by JS) -->
    <div id="mxRoomMenu" hidden></div>
  </div>
  <div class="updated" id="mxUpdated">—</div>
  <button id="toggleMetrics" type="button" aria-expanded="false">Show</button>
</div>
  <div class="body" id="mxBody">
    <div class="grid">
      <div class="mcard" id="mTemp">
        <div class="row">
          <div class="label">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M17 6V5a5 5 0 0 0-10 0v1a3 3 0 0 0-1 2v5.268a5.5 5.5 0 1 0 12 0V8a3 3 0 0 0-1-2Z"/></svg>
            Temperature
          </div><div class="dot" id="mTempDot"></div>
        </div><div class="value" id="mTempVal">—</div>
      </div>

      <div class="mcard" id="mHum">
        <div class="row">
          <div class="label">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2s7 7.163 7 11a7 7 0 1 1-14 0c0-3.837 7-11 7-11Z"/></svg>
            Humidity
          </div><div class="dot" id="mHumDot"></div>
        </div><div class="value" id="mHumVal">—</div>
      </div>

      <div class="mcard" id="mTvoc">
        <div class="row">
          <div class="label">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v4H4zM4 10h16v10H4z"/></svg>
            TVOC
          </div><div class="dot" id="mTvocDot"></div>
        </div><div class="value" id="mTvocVal">—</div>
      </div>

      <div class="mcard" id="mEco2">
        <div class="row">
          <div class="label">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M7 7h10v10H7z"/></svg>
            eCO2
          </div><div class="dot" id="mEco2Dot"></div>
        </div><div class="value" id="mEco2Val">—</div>
      </div>

      <div class="mcard" id="mOcc">
        <div class="row">
          <div class="label">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a3 3 0 1 0-3-3a3 3 0 0 0 3 3Zm7 8v-1a5 5 0 0 0-5-5H10a5 5 0 0 0-5 5v1Z"/></svg>
            Estimated Occupancy
          </div><div class="dot" id="mOccDot"></div>
        </div><div class="value" id="mOccVal">—</div>
      </div>
    </div>
  </div>
</div>

<!-- mqtt.js (browser bundle) -->
<script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>

  <!-- Autodesk Viewer -->
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- App code -->
  <script type="module" src="/js/viewer.js"></script>
  <script type="module" src="/js/app_ui.js"></script>
  <script type="module" src="/js/app_metrics.js"></script>
  <script type="module" src="/js/plug_metrics.js"></script>
  <script type="module" src="/js/lights_metrics.js"></script>
  <script type="module" src="/js/live_data_viewer.js"></script>
  <script type="module" src="/js/day_playback.js"></script>
  <script type="module" src="/js/day_playback_ui.js"></script>
  <link rel="stylesheet" href="/assets/heatmap.css" />
  <script type="module" src="/js/heatmap.js"></script>
  <script type="module" src="/js/heatmap_ui.js"></script>
  <script type="module" src="/js/rules.js"></script>
  <script type="module" src="/js/rules_ui.js"></script>
  <script type="module" src="/js/alerts.js"></script>
  <script type="module" src="/js/alerts_ui.js"></script>

</body>
</html>
