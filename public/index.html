<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>APS Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet"
    href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css"/>
  <style>
    html, body, #viewer { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #badge {
      position: absolute; top:10px; left:10px; z-index: 5;
      background:#111; color:#fff; font: 14px/1 system-ui, sans-serif;
      padding:10px 14px; border-radius:8px; opacity:.85;
      pointer-events: none;
    }
    #dashBtn {
      position: absolute; top:30px; left:30px; z-index:6;
      background:#0d6efd; color:#fff; border:0; border-radius:10px;
      padding:10px 14px; font: 14px/1 system-ui, sans-serif; cursor:pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    #overlay {
      position: fixed; inset:0; display:none; place-items:center; z-index: 10;
      background: rgba(0,0,0,.35);
    }
    #panel {
      width:80vw; height:80vh; background:#fff; border-radius:14px; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.35); position: relative;
    }
    #panel iframe { width:100%; height:100%; border:0; }
    #close {
      position:absolute; top:8px; right:8px; z-index:11;
      background: #111; color:#fff; border:0; border-radius:999px;
      width:34px; height:34px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>
  
  <button id="dashBtn">Open Dashboard</button>

  <div id="overlay" role="dialog" aria-modal="true">
    <div id="panel">
      <button id="close" title="Close">âœ•</button>
      <iframe id="dashFrame"
        src="https://twindashboard.davidiyiola.com/ui/"></iframe>
    </div>
  </div>

  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <script>
    function getAccessToken(onTokenReady) {
      fetch('/api/token')
        .then(r => r.json())
        .then(d => onTokenReady(d.access_token, d.expires_in))
        .catch(err => console.error('Token error:', err));
    }

    Autodesk.Viewing.Initializer(
      { env: 'AutodeskProduction', api: 'derivativeV2', region: 'US', getAccessToken },
      function () {
        const viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('viewer'));
        const started = viewer.start();
        if (started !== 0) { console.error('Viewer start failed:', started); return; }

        const urn = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6d3doX2RpZ2l0YWxfdHdpbl9sYWIvV1dIX0xhYl8wMTUucnZ0';

        Autodesk.Viewing.Document.load(
          urn,
          function (doc) {
            const defaultModel = doc.getRoot().getDefaultGeometry();
            viewer.loadDocumentNode(doc, defaultModel, {})
              .then(() => console.log('Model loaded'))
              .catch(e => console.error('loadDocumentNode error:', e));
          },
          function (code) { console.error('Document.load error:', code); }
        );

        viewer.addEventListener(Autodesk.Viewing.VIEWER_ERROR, e => console.error('VIEWER_ERROR', e));
      }
    );

    // Overlay controls
    const $overlay = document.getElementById('overlay');
    const $open = document.getElementById('dashBtn');
    const $close = document.getElementById('close');

    $open.onclick = () => ($overlay.style.display = 'grid');
    $close.onclick = () => ($overlay.style.display = 'none');
    window.addEventListener('keydown', e => { if (e.key === 'Escape') $overlay.style.display = 'none'; });
  </script>
</body>
</html>